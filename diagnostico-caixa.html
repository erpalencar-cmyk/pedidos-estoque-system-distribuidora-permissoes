<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico - Estado da Sessão PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/config.js"></script>
    <script src="./js/session-manager.js"></script>
    <script src="./js/utils.js"></script>
    <script src="./js/auth.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold mb-2">
                <i class="fas fa-stethoscope mr-2 text-red-600"></i>Diagnóstico - Sessões de Caixa
            </h1>
            <p class="text-gray-600 mb-6">Verificando estado das sessões abertas</p>

            <div id="conteudo" class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-gray-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Carregando dados...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function diagnosticar() {
            const container = document.getElementById('conteudo');

            try {
                // 1. Obter usuário atual
                const usuario = await getCurrentUser();
                
                container.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600">
                        <h2 class="font-bold text-blue-900 mb-2">
                            <i class="fas fa-user mr-2"></i>Usuário Atual
                        </h2>
                        <p class="text-blue-800">ID: ${usuario.id}</p>
                        <p class="text-blue-800">Nome: ${usuario.nome_completo}</p>
                        <p class="text-blue-800">Role: ${usuario.role}</p>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-600">
                        <h2 class="font-bold text-yellow-900 mb-3">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Buscando caixa_sessoes...
                        </h2>
                        <p id="status-busca" class="text-yellow-800">Aguarde...</p>
                    </div>
                `;

                // 2. Buscar TODAS as sessões abertas para este operador
                const { data: sessionAberta, error: errorAberta } = await supabase
                    .from('caixa_sessoes')
                    .select('id, caixa_id, operador_id, status, data_abertura, valor_abertura, caixas(id, numero, nome)')
                    .eq('operador_id', usuario.id)
                    .eq('status', 'ABERTO')
                    .single();

                let resultado = `
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600">
                        <h2 class="font-bold text-blue-900 mb-2">
                            <i class="fas fa-user mr-2"></i>Usuário Atual
                        </h2>
                        <p class="text-blue-800">ID: ${usuario.id}</p>
                        <p class="text-blue-800">Nome: ${usuario.nome_completo}</p>
                        <p class="text-blue-800">Role: ${usuario.role}</p>
                    </div>
                `;

                if (!sessionAberta && errorAberta?.code === 'PGRST116') {
                    resultado += `
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-600">
                            <h2 class="font-bold text-green-900 mb-2">
                                <i class="fas fa-check-circle mr-2"></i>✅ Situação CORRETA
                            </h2>
                            <p class="text-green-800">Nenhuma sessão aberta encontrada para este operador</p>
                            <p class="text-green-800 mt-2">A página PDV deve:</p>
                            <ul class="text-green-800 ml-4 mt-2 space-y-1 list-disc">
                                <li>Exibir status FECHADO (vermelho)</li>
                                <li>Mostrar botão "Abrir Caixa"</li>
                                <li>Exibir modal de abertura automaticamente</li>
                            </ul>
                        </div>
                    `;
                } else if (sessionAberta) {
                    resultado += `
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600">
                            <h2 class="font-bold text-red-900 mb-2">
                                <i class="fas fa-alert-circle mr-2"></i>⚠️ Sessão Encontrada
                            </h2>
                            <p class="text-red-800 mb-3">Uma sessão aberta foi encontrada:</p>
                            <div class="bg-white p-3 rounded text-red-800 font-mono text-sm">
                                <p>ID: ${sessionAberta.id}</p>
                                <p>Caixa: ${sessionAberta.caixas?.numero} - ${sessionAberta.caixas?.nome}</p>
                                <p>Status: ${sessionAberta.status}</p>
                                <p>Abertura: ${new Date(sessionAberta.data_abertura).toLocaleString('pt-BR')}</p>
                                <p>Saldo: R$ ${sessionAberta.valor_abertura?.toFixed(2) || '0.00'}</p>
                            </div>
                            <p class="text-red-800 mt-3">A página PDV mostrará:</p>
                            <ul class="text-red-800 ml-4 mt-2 space-y-1 list-disc">
                                <li>Status ABERTO (verde) - Correto!</li>
                                <li>Número do caixa: ${sessionAberta.caixas?.numero}</li>
                                <li>Botão "Fechar Caixa"</li>
                            </ul>
                        </div>
                    `;
                } else {
                    resultado += `
                        <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-600">
                            <h2 class="font-bold text-orange-900 mb-2">
                                <i class="fas fa-question-circle mr-2"></i>❓ Erro na Query
                            </h2>
                            <p class="text-orange-800">Erro ao buscar sessões:</p>
                            <div class="bg-white p-3 rounded text-orange-800 font-mono text-sm mt-2">
                                ${JSON.stringify(errorAberta, null, 2)}
                            </div>
                        </div>
                    `;
                }

                // 3. Mostrar todas as sessões deste operador (não apenas abertas)
                const { data: todasSessions } = await supabase
                    .from('caixa_sessoes')
                    .select('id, caixa_id, operador_id, status, data_abertura, data_fechamento')
                    .eq('operador_id', usuario.id)
                    .order('data_abertura', { ascending: false })
                    .limit(10);

                resultado += `
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-gray-600">
                        <h2 class="font-bold text-gray-900 mb-2">
                            <i class="fas fa-history mr-2"></i>Últimas 10 Sessões (Qualquer Status)
                        </h2>
                        ${todasSessions && todasSessions.length > 0 ? `
                            <div class="space-y-2 mt-2">
                                ${todasSessions.map(s => `
                                    <div class="bg-white p-2 rounded text-sm">
                                        <span class="font-mono">ID: ${s.id.substring(0, 8)}...</span> |
                                        <span class="font-semibold ${s.status === 'ABERTO' ? 'text-green-600' : 'text-gray-600'}">${s.status}</span> |
                                        <span>${new Date(s.data_abertura).toLocaleString('pt-BR')}</span>
                                        ${s.status === 'FECHADO' ? `| Fechado: ${new Date(s.data_fechamento).toLocaleString('pt-BR')}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-gray-600">Nenhuma sessão encontrada para este operador</p>
                        `}
                    </div>
                `;

                // 4. Recomendações
                resultado += `
                    <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-600">
                        <h2 class="font-bold text-indigo-900 mb-2">
                            <i class="fas fa-lightbulb mr-2"></i>O que Fazer
                        </h2>
                        <ol class="text-indigo-800 space-y-2 ml-4 list-decimal">
                            <li>Se mostra "Sessão Encontrada" → Abra a página PDV, deve mostrar CAIXA ABERTO (verde)</li>
                            <li>Se mostra "Situação CORRETA" → Abra a página PDV, deve mostrar CAIXA FECHADO (vermelho) + modal</li>
                            <li>Se apresenta erro → Verifique console do navegador (F12)</li>
                        </ol>
                    </div>

                    <div class="mt-6 space-y-2">
                        <button onclick="window.location.href='./pages/pdv.html'" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            <i class="fas fa-arrow-right mr-2"></i>Abrir PDV
                        </button>
                        <button onclick="location.reload()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <i class="fas fa-sync mr-2"></i>Atualizar Diagnóstico
                        </button>
                    </div>
                `;

                container.innerHTML = resultado;

            } catch (error) {
                container.innerHTML = `
                    <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-600">
                        <h2 class="font-bold text-red-900 mb-2">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Erro
                        </h2>
                        <p class="text-red-800">${error.message}</p>
                        <pre class="bg-white p-3 rounded mt-2 text-red-800 font-mono text-xs overflow-auto">
${JSON.stringify(error, null, 2)}
                        </pre>
                    </div>
                `;
            }
        }

        // Executar ao carregar
        window.addEventListener('DOMContentLoaded', diagnosticar);
    </script>
</body>
</html>
