<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Nuvem Fiscal - Integra√ß√£o Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .log-entry { padding: 8px 12px; border-left: 3px solid; margin-bottom: 6px; border-radius: 4px; }
        .log-info { background: #E0F2FE; border-color: #0284C7; color: #0C4A6E; }
        .log-success { background: #DCFCE7; border-color: #16A34A; color: #14532D; }
        .log-error { background: #FEE2E2; border-color: #DC2626; color: #7F1D1D; }
        .log-warning { background: #FEF3C7; border-color: #F59E0B; color: #78350F; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="navbar"></div>
    <div id="sidebar-container"></div>

    <main class="lg:ml-64 pt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Cabe√ßalho -->
            <div class="mb-8">
                <h2 class="text-4xl font-bold text-gray-900">
                    <i class="fas fa-cloud mr-3 text-cyan-600"></i>Teste de Integra√ß√£o Nuvem Fiscal
                </h2>
                <p class="text-gray-600 mt-2">Teste e valide a conex√£o com a API Nuvem Fiscal (OAuth2)</p>
            </div>

            <!-- Status da Configura√ß√£o -->
            <div id="config-status" class="mb-6 p-6 bg-white rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-cog mr-2 text-gray-600"></i>Status da Configura√ß√£o OAuth2
                </h3>
                
                <!-- Banner OAuth2 -->
                <div class="mb-4 p-4 bg-cyan-50 border border-cyan-300 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-shield-alt text-cyan-600 text-xl mr-3 mt-1"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-cyan-800 mb-1">üîê Autentica√ß√£o OAuth2 Segura</h4>
                            <p class="text-sm text-cyan-700">
                                Sistema configurado para usar <strong>OAuth2 Client Credentials</strong>. 
                                Tokens s√£o renovados automaticamente a cada 30 dias, garantindo 
                                <strong>seguran√ßa e disponibilidade cont√≠nua</strong>.
                            </p>
                            <p class="text-xs text-cyan-600 mt-2">
                                üîë Client ID p√∫blico | üîí Client Secret privado | ‚ö° Token auto-renovado | üÜì Plano gratuito dispon√≠vel
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="config-info" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500 mb-1">Client ID</div>
                        <div id="clientid-info" class="font-semibold text-gray-900 truncate">Carregando...</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500 mb-1">Client Secret</div>
                        <div id="secret-info" class="font-semibold text-gray-900">Carregando...</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500 mb-1">Access Token</div>
                        <div id="token-info" class="font-semibold text-gray-900">Carregando...</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-500 mb-1">Token Expira</div>
                        <div id="expiry-info" class="font-semibold text-gray-900">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- Painel de Testes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Coluna Esquerda: Testes -->
                <div class="space-y-6">
                    <!-- Teste 1: OAuth2 Token -->
                    <div class="bg-gradient-to-r from-cyan-600 to-blue-600 rounded-lg shadow-md p-6 text-white">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-key mr-2"></i>Teste 1: Obter Access Token OAuth2
                        </h3>
                        <p class="text-sm mb-4 opacity-90">Requisita novo token usando Client ID e Secret</p>
                        <button onclick="testarOAuth2()" class="w-full px-4 py-3 bg-white text-cyan-700 rounded-lg hover:bg-gray-100 font-semibold">
                            <i class="fas fa-unlock-alt mr-2"></i>Obter Token OAuth2
                        </button>
                    </div>

                    <!-- Teste 2: Consulta CEP -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>Teste 2: Consulta de CEP
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Testa a API consultando um CEP (100.000/m√™s gr√°tis)</p>
                        <div class="mb-4">
                            <input type="text" id="cep-input" placeholder="Ex: 01310100" maxlength="8" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <button onclick="testarConsultaCEP()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                            <i class="fas fa-search mr-2"></i>Consultar CEP
                        </button>
                    </div>

                    <!-- Teste 3: Consulta CNPJ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-building mr-2 text-blue-600"></i>Teste 3: Consulta de CNPJ
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Consulta dados cadastrais via CNPJ (50.000/m√™s gr√°tis)</p>
                        <div class="mb-4">
                            <input type="text" id="cnpj-input" placeholder="Ex: 00000000000191" maxlength="14" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button onclick="testarConsultaCNPJ()" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                            <i class="fas fa-search mr-2"></i>Consultar CNPJ
                        </button>
                    </div>

                    <!-- Teste 4: Status SEFAZ -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-signal mr-2 text-yellow-600"></i>Teste 4: Status SEFAZ
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Verifica disponibilidade dos servi√ßos da SEFAZ</p>
                        <button onclick="testarStatusSEFAZ()" class="w-full px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 font-semibold">
                            <i class="fas fa-server mr-2"></i>Consultar Status
                        </button>
                    </div>

                    <!-- Teste 5: Configurar Empresa -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-cogs mr-2 text-purple-600"></i>Teste 5: Configurar Empresa na API
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Configura CSC para emiss√£o de NFC-e</p>
                        <button onclick="testarConfigurarEmpresa()" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                            <i class="fas fa-upload mr-2"></i>Configurar Empresa
                        </button>
                    </div>

                    <!-- Teste 6: Listar Notas -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-list mr-2 text-indigo-600"></i>Teste 6: Listar NFC-e Emitidas
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Lista as √∫ltimas NFC-e emitidas</p>
                        <button onclick="listarNotas()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                            <i class="fas fa-list-ul mr-2"></i>Listar Notas
                        </button>
                    </div>

                    <!-- Bot√£o: Executar Todos os Testes -->
                    <div class="bg-gradient-to-r from-teal-600 to-emerald-600 rounded-lg shadow-md p-6 text-white">
                        <h3 class="text-lg font-bold mb-4 flex items-center">
                            <i class="fas fa-tasks mr-2"></i>Executar Todos os Testes
                        </h3>
                        <p class="text-sm mb-4 opacity-90">Executa todos os testes sequencialmente</p>
                        <button onclick="executarTodosTestes()" class="w-full px-4 py-3 bg-white text-teal-700 rounded-lg hover:bg-gray-100 font-semibold">
                            <i class="fas fa-play mr-2"></i>Executar Todos
                        </button>
                    </div>
                </div>

                <!-- Coluna Direita: Log -->
                <div class="bg-white rounded-lg shadow-md p-6 h-fit sticky top-20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold flex items-center">
                            <i class="fas fa-terminal mr-2 text-gray-600"></i>Log de Testes
                        </h3>
                        <button onclick="limparLog()" class="text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-trash mr-1"></i>Limpar
                        </button>
                    </div>
                    <div id="log-container" class="h-[600px] overflow-y-auto bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="text-sm text-gray-500 text-center py-8">
                            <i class="fas fa-info-circle text-3xl mb-2"></i>
                            <p>Execute um teste para ver os resultados aqui</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informa√ß√µes sobre Plano Gratuito -->
            <div class="bg-cyan-50 border-l-4 border-cyan-400 p-6 rounded-lg shadow-md mb-6">
                <div class="flex items-start">
                    <i class="fas fa-gift text-cyan-600 text-2xl mr-4 mt-1"></i>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-cyan-900 mb-2">üéÅ Plano Gratuito Nuvem Fiscal</h3>
                        <div class="text-sm text-cyan-800 space-y-2">
                            <p><strong>Recursos inclu√≠dos gratuitamente:</strong></p>
                            <ul class="list-disc ml-6 space-y-1">
                                <li><strong>1.000 NFC-e/m√™s</strong> - Notas fiscais ao consumidor</li>
                                <li><strong>100.000 Consultas CEP/m√™s</strong> - Auto-completar endere√ßos</li>
                                <li><strong>50.000 Consultas CNPJ/m√™s</strong> - Dados cadastrais de empresas</li>
                                <li><strong>OAuth2 Seguro</strong> - Autentica√ß√£o moderna e confi√°vel</li>
                            </ul>
                            <div class="bg-white p-3 rounded border border-cyan-300 my-2">
                                <p class="font-semibold mb-2">üìã Para usar:</p>
                                <ol class="list-decimal ml-6 space-y-1">
                                    <li>Crie conta em: <a href="https://nuvemfiscal.com.br" target="_blank" class="text-cyan-700 underline">nuvemfiscal.com.br</a></li>
                                    <li>Acesse: <a href="https://console.nuvemfiscal.com.br" target="_blank" class="text-cyan-700 underline">console.nuvemfiscal.com.br</a></li>
                                    <li>Crie credencial (Sandbox ou Produ√ß√£o)</li>
                                    <li>Configure em <strong>Configura√ß√µes da Empresa</strong></li>
                                    <li>Teste aqui nesta p√°gina!</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/session-manager.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/rbac.js"></script>
    <script src="../js/services/empresa.js"></script>
    <script src="../js/services/nuvem-fiscal.js"></script>
    <script src="../components/navbar.js"></script>
    <script src="../components/sidebar.js"></script>
    
    <script>
        let empresaConfig = null;
        // NuvemFiscal j√° √© instanciado no nuvem-fiscal.js

        // ========== FUN√á√ïES DE LOG ==========
        function addLog(mensagem, tipo = 'info') {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            
            const icones = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle'
            };

            const log = document.createElement('div');
            log.className = `log-entry log-${tipo}`;
            log.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${icones[tipo]} mr-2 mt-1"></i>
                    <div class="flex-1">
                        <div class="text-xs opacity-75 mb-1">${timestamp}</div>
                        <div class="text-sm">${mensagem}</div>
                    </div>
                </div>
            `;
            
            const placeholder = container.querySelector('.text-center');
            if (placeholder) placeholder.remove();
            
            container.insertBefore(log, container.firstChild);
            container.scrollTop = 0;
        }

        function limparLog() {
            const container = document.getElementById('log-container');
            container.innerHTML = `
                <div class="text-sm text-gray-500 text-center py-8">
                    <i class="fas fa-info-circle text-3xl mb-2"></i>
                    <p>Execute um teste para ver os resultados aqui</p>
                </div>
            `;
        }

        // ========== CARREGAR CONFIGURA√á√ÉO ==========
        async function carregarConfiguracao() {
            try {
                empresaConfig = await getEmpresaConfig();
                
                if (!empresaConfig) {
                    document.getElementById('clientid-info').innerHTML = '<span class="text-red-600">‚ùå N√£o configurado</span>';
                    document.getElementById('secret-info').innerHTML = '<span class="text-red-600">‚ùå N√£o configurado</span>';
                    document.getElementById('token-info').innerHTML = '<span class="text-red-600">‚ùå Sem token</span>';
                    document.getElementById('expiry-info').innerHTML = '<span class="text-gray-600">‚Äî</span>';
                    addLog('‚ö†Ô∏è Configura√ß√£o da empresa n√£o encontrada. Configure em Configura√ß√µes > Empresa.', 'error');
                    return;
                }

                // Client ID
                const hasClientId = empresaConfig.nuvemfiscal_client_id && empresaConfig.nuvemfiscal_client_id.length > 0;
                if (hasClientId) {
                    const clientIdTruncado = empresaConfig.nuvemfiscal_client_id.substring(0, 12) + '...';
                    document.getElementById('clientid-info').innerHTML = `<span class="text-green-600" title="${empresaConfig.nuvemfiscal_client_id}">${clientIdTruncado}</span>`;
                } else {
                    document.getElementById('clientid-info').innerHTML = '<span class="text-red-600">‚ùå N√£o configurado</span>';
                }

                // Client Secret
                const hasSecret = empresaConfig.nuvemfiscal_client_secret && empresaConfig.nuvemfiscal_client_secret.length > 0;
                document.getElementById('secret-info').innerHTML = hasSecret ? 
                    '<span class="text-green-600">‚úì Configurado</span>' : 
                    '<span class="text-red-600">‚ùå N√£o configurado</span>';

                // Access Token
                const hasToken = empresaConfig.nuvemfiscal_access_token && empresaConfig.nuvemfiscal_access_token.length > 0;
                document.getElementById('token-info').innerHTML = hasToken ? 
                    '<span class="text-green-600">‚úì Em cache</span>' : 
                    '<span class="text-yellow-600">‚ö† Ser√° obtido</span>';

                // Token Expiry
                if (empresaConfig.nuvemfiscal_token_expiry) {
                    const expiry = new Date(empresaConfig.nuvemfiscal_token_expiry);
                    const agora = new Date();
                    const diasRestantes = Math.ceil((expiry - agora) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes > 7) {
                        document.getElementById('expiry-info').innerHTML = `<span class="text-green-600">${diasRestantes} dias</span>`;
                    } else if (diasRestantes > 0) {
                        document.getElementById('expiry-info').innerHTML = `<span class="text-yellow-600">‚ö† ${diasRestantes} dias</span>`;
                    } else {
                        document.getElementById('expiry-info').innerHTML = '<span class="text-red-600">‚ùå Expirado</span>';
                    }
                } else {
                    document.getElementById('expiry-info').innerHTML = '<span class="text-gray-600">‚Äî</span>';
                }

                if (hasClientId && hasSecret) {
                    addLog('‚úÖ Credenciais OAuth2 configuradas', 'success');
                } else {
                    addLog('‚ö†Ô∏è Configure Client ID e Client Secret em Configura√ß√µes da Empresa', 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o:', error);
                addLog('‚ùå Erro ao carregar configura√ß√£o: ' + error.message, 'error');
            }
        }

        // ========== TESTE 1: OAUTH2 TOKEN ==========
        async function testarOAuth2() {
            try {
                addLog('üîê Iniciando teste de OAuth2...', 'info');
                
                const token = await NuvemFiscal.getAccessToken();
                
                addLog('‚úÖ Access Token obtido com sucesso!', 'success');
                addLog(`Token: ${token.substring(0, 50)}...`, 'info');
                
                // Recarregar configura√ß√£o para ver token em cache
                await carregarConfiguracao();
                
                showToast('Token OAuth2 obtido com sucesso!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao obter token OAuth2: ' + error.message, 'error');
                showToast('Erro ao obter token: ' + error.message, 'error');
            }
        }

        // ========== TESTE 2: CONSULTA CEP ==========
        async function testarConsultaCEP() {
            try {
                const cep = document.getElementById('cep-input').value.replace(/\D/g, '');
                
                if (!cep || cep.length !== 8) {
                    addLog('‚ö†Ô∏è Digite um CEP v√°lido (8 d√≠gitos)', 'warning');
                    showToast('Digite um CEP v√°lido', 'error');
                    return;
                }

                addLog(`üîç Consultando CEP: ${cep}...`, 'info');
                
                const resultado = await NuvemFiscal.consultarCEP(cep);
                
                addLog('‚úÖ CEP encontrado!', 'success');
                addLog(`üìç ${resultado.logradouro}`, 'info');
                addLog(`üìç ${resultado.bairro}, ${resultado.cidade}/${resultado.uf}`, 'info');
                addLog(`üìç C√≥digo IBGE: ${resultado.codigo_ibge}`, 'info');
                
                showToast('CEP consultado com sucesso!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao consultar CEP: ' + error.message, 'error');
                showToast('Erro ao consultar CEP', 'error');
            }
        }

        // ========== TESTE 3: CONSULTA CNPJ ==========
        async function testarConsultaCNPJ() {
            try {
                const cnpj = document.getElementById('cnpj-input').value.replace(/\D/g, '');
                
                if (!cnpj || cnpj.length !== 14) {
                    addLog('‚ö†Ô∏è Digite um CNPJ v√°lido (14 d√≠gitos)', 'warning');
                    showToast('Digite um CNPJ v√°lido', 'error');
                    return;
                }

                addLog(`üîç Consultando CNPJ: ${cnpj}...`, 'info');
                
                const resultado = await NuvemFiscal.consultarCNPJ(cnpj);
                
                addLog('‚úÖ CNPJ encontrado!', 'success');
                addLog(`üè¢ ${resultado.razao_social}`, 'info');
                addLog(`üìç ${resultado.endereco?.municipio}/${resultado.endereco?.uf}`, 'info');
                addLog(`üìä Situa√ß√£o: ${resultado.situacao_cadastral?.descricao}`, 'info');
                
                showToast('CNPJ consultado com sucesso!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao consultar CNPJ: ' + error.message, 'error');
                showToast('Erro ao consultar CNPJ', 'error');
            }
        }

        // ========== TESTE 4: STATUS SEFAZ ==========
        async function testarStatusSEFAZ() {
            try {
                addLog('üì° Consultando status SEFAZ...', 'info');
                
                if (!empresaConfig?.cnpj) {
                    addLog('‚ö†Ô∏è CNPJ n√£o configurado', 'warning');
                    showToast('Configure o CNPJ da empresa primeiro', 'error');
                    return;
                }

                addLog(`üîç CNPJ: ${empresaConfig.cnpj}`, 'info');
                addLog(`üåê Ambiente: ${empresaConfig.focusnfe_ambiente === 1 ? 'Produ√ß√£o' : 'Homologa√ß√£o'}`, 'info');
                
                const resultado = await NuvemFiscal.consultarStatusSefaz(empresaConfig.cnpj, empresaConfig.estado || empresaConfig.uf);
                
                addLog('‚úÖ Status SEFAZ obtido!', 'success');
                addLog(`üìä Status: ${resultado.xMotivo || resultado.motivo || resultado.mensagem}`, 'success');
                if (resultado.codigo_status) {
                    addLog(`üìã C√≥digo: ${resultado.codigo_status}`, 'info');
                }
                addLog(`üïê √öltima verifica√ß√£o: ${new Date().toLocaleString()}`, 'info');
                
                showToast('SEFAZ dispon√≠vel!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao consultar status: ' + error.message, 'error');
                if (error.message.includes('400')) {
                    addLog('üí° Dica: Verifique se o CNPJ est√° configurado corretamente', 'warning');
                    addLog('üí° Ou tente configurar a empresa primeiro (Teste 5)', 'warning');
                }
                showToast('Erro ao consultar SEFAZ', 'error');
            }
        }

        // ========== TESTE 5: CONFIGURAR EMPRESA ==========
        async function testarConfigurarEmpresa() {
            try {
                addLog('‚öôÔ∏è Configurando empresa na Nuvem Fiscal...', 'info');
                
                if (!empresaConfig?.cnpj) {
                    addLog('‚ö†Ô∏è CNPJ n√£o configurado', 'warning');
                    showToast('Configure o CNPJ da empresa primeiro', 'error');
                    return;
                }

                if (!empresaConfig?.csc_id || !empresaConfig?.csc_token) {
                    addLog('‚ö†Ô∏è CSC n√£o configurado', 'warning');
                    showToast('Configure o CSC primeiro em Configura√ß√µes da Empresa', 'error');
                    return;
                }

                const crt = empresaConfig.regime_tributario_codigo || empresaConfig.regime_tributario || '1';
                const config = {
                    crt: crt,
                    id_csc: empresaConfig.csc_id,
                    csc: empresaConfig.csc_token,
                    ambiente: empresaConfig.focusnfe_ambiente === 1 ? 'producao' : 'homologacao'
                };

                addLog(`üóÇ CNPJ: ${empresaConfig.cnpj}`, 'info');
                addLog(`üìã CRT: ${config.crt}`, 'info');
                addLog(`üîê CSC ID: ${config.id_csc}`, 'info');
                addLog(`üåê Ambiente: ${config.ambiente}`, 'info');

                const resultado = await NuvemFiscal.configurarEmpresa(empresaConfig.cnpj, config);
                
                addLog('‚úÖ Empresa configurada com sucesso!', 'success');
                if (resultado.mensagem) {
                    addLog(`üí¨ ${resultado.mensagem}`, 'info');
                }
                
                showToast('Empresa configurada na Nuvem Fiscal!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao configurar empresa: ' + error.message, 'error');
                if (error.message.includes('404')) {
                    addLog('üí° Dica: O endpoint de configura√ß√£o pode n√£o existir no plano gratuito', 'warning');
                    addLog('üí° Voc√™ pode emitir notas diretamente sem configura√ß√£o pr√©via', 'warning');
                    addLog('üí° Pule este teste e tente os outros', 'info');
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    addLog('üí° Dica: Verifique suas credenciais OAuth2', 'warning');
                }
                showToast('Erro ao configurar empresa', 'error');
            }
        }

        // ========== TESTE 6: LISTAR NOTAS ==========
        async function listarNotas() {
            try {
                addLog('üìã Listando NFC-e emitidas...', 'info');
                
                if (!empresaConfig?.cnpj) {
                    addLog('‚ö†Ô∏è CNPJ n√£o configurado', 'warning');
                    showToast('Configure o CNPJ da empresa primeiro', 'error');
                    return;
                }

                const resultado = await NuvemFiscal.listarNFCe(empresaConfig.cnpj, 'homologacao');
                
                if (resultado.data && resultado.data.length > 0) {
                    addLog(`‚úÖ Encontradas ${resultado.data.length} NFC-e`, 'success');
                    
                    resultado.data.slice(0, 5).forEach(nota => {
                        addLog(`üìÑ N¬∫ ${nota.numero} - ${nota.status} - ${nota.data_emissao}`, 'info');
                    });
                } else {
                    addLog('‚ÑπÔ∏è Nenhuma NFC-e encontrada', 'info');
                }
                
                showToast('Consulta conclu√≠da!', 'success');
            } catch (error) {
                addLog('‚ùå Erro ao listar notas: ' + error.message, 'error');
                showToast('Erro ao listar notas', 'error');
            }
        }

        // ========== EXECUTAR TODOS OS TESTES ==========
        async function executarTodosTestes() {
            addLog('üöÄ Iniciando bateria de testes completa...', 'info');
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testarOAuth2();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            document.getElementById('cep-input').value = '01310100';
            await testarConsultaCEP();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            if (empresaConfig?.cnpj) {
                document.getElementById('cnpj-input').value = empresaConfig.cnpj;
                await testarConsultaCNPJ();
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testarStatusSEFAZ();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testarConfigurarEmpresa();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            await listarNotas();
            
            addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
            addLog('‚úÖ Todos os testes conclu√≠dos!', 'success');
            showToast('Bateria de testes conclu√≠da!', 'success');
        }

        // ========== INICIALIZA√á√ÉO ==========
        (async () => {
            await checkAuth();
            
            if (!(await RBACSystem.protegerPagina(['ADMIN', 'GERENTE']))) {
                return;
            }

            document.getElementById('navbar').innerHTML = createNavbar();
            document.getElementById('sidebar-container').innerHTML = createSidebar();
            await initNavbar();
            await initSidebar();
            await carregarConfiguracao();
        })();
    </script>
</body>
</html>
